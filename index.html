<!DOCTYPE html>
<html lang="ja">
<meta charset="UTF-8">
<title>今日の予定</title>

<h2>今日の予定</h2>
<ul id="list">読み込み中…</ul>

<script>
const RAW_ICAL =
"https://calendar.google.com/calendar/ical/10bbcc5e95ad3ebc84ca5245eabc6a817e21cc54898d0ebe61a9ea202e38442a@group.calendar.google.com/public/basic.ics";

// ★ CORS回避（これが必須）
const ICAL_URL =
"https://cors.isomorphic-git.org/" + RAW_ICAL;


// ★ JSTで今日を取得
const now = new Date(Date.now() + 9*60*60*1000);
const today = now.toISOString().slice(0,10).replace(/-/g,"");

fetch(ICAL_URL)
.then(r => r.text())
.then(t => {
  const list = document.getElementById("list");
  list.innerHTML = "";

  const events = t.split("BEGIN:VEVENT").slice(1);
  const todayEvents = [];

  events.forEach(e => {
    const s = e.match(/SUMMARY:(.+)/)?.[1];
    const d = e.match(/DTSTART[^:]*:(\d{8}(T\d{6})?)/)?.[1];
    if (!s || !d) return;
    if (d.slice(0,8) !== today) return;

    const time = d.length === 8 ? "終日" : d.slice(9,11)+":"+d.slice(11,13);
    todayEvents.push({ time, title: s });
  });

  todayEvents.sort((a,b)=>a.time.localeCompare(b.time));

  if (!todayEvents.length) {
    list.innerHTML = "<li>本日の予定はありません</li>";
    return;
  }

  todayEvents.forEach(ev=>{
    list.innerHTML += `<li>${ev.time} ${ev.title}</li>`;
  });
})
.catch(()=>{
  document.getElementById("list").innerHTML =
    "<li>カレンダーを取得できません</li>";
});
</script>
